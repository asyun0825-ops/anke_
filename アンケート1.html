<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>アンケート</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    /* プログレスバーのスタイル（進捗状況メーター） */
    #progressContainer {
      margin-bottom: 20px;
      text-align: center;
    }
    progress {
      width: 80%;
      height: 25px;
    }
    

    .evaluation-area meter {
    }

    /* ★追加: 共通の参考音声エリアのスタイル */
    #globalReferenceContainer {
        border: 2px solid #007bff;
        padding: 15px;
        margin-bottom:15px;
        border-radius: 8px;
        background-color: #e9f7ff;
    }
    .global-audio-item {
        margin-top: 10px;
        display: inline-block; /* 横並びにする */
        margin-right: 10px;
    }
    /* 個別の質問用の参考音声は今回は削除。もし残したい場合は元のコードを参照 */
  </style>
</head>
<body>
  <h1>アンケート</h1>
  
  <div id="progressContainer">
    <label for="progressMeter">進捗状況:</label>
    <progress id="progressMeter" value="0" max="1"></progress> 
    <span id="progressText">0 / 1</span>
  </div>

  <div id="globalReferenceContainer">
      <h2>母音の参考音声</h2>
      </div>
    
  <div id="questionContainer"></div>
  
  <button onclick="submitAnswers()">回答を保存</button>
  
<script>
  // 共通の参考音声データ 
  const globalReferenceAudios = [
      { name: 'あ', src: 'full_Lv1_1_4_a.wav' },
      { name: 'い', src: 'full_Lv1_1_4_i.wav' },
      { name: 'う', src: 'full_Lv1_1_4_u.wav' },
      { name: 'え', src: 'full_Lv1_1_4_e.wav' },
      { name: 'お', src: 'full_Lv1_1_4_o.wav' } 
  ];
  
  // 評価対象の母音リスト
  const vowels = ['あ', 'い', 'う', 'え', 'お']; 

  // 設問データ 
  const questions = [
    { id: '1kaosa', audioSrc: "full_VM6C_0mm_1_kaos_a.wav" }, 
    { id: '1kaosi', audioSrc: 'full_VM6C_0mm_1_kaos_i.wav' },
    { id: '1kaosu', audioSrc: 'full_VM6C_0mm_1_kaos_u.wav' },
    { id: '1kaose', audioSrc: 'full_VM6C_0mm_1_kaos_e.wav' },
    { id: '1kaoso', audioSrc: "full_VM6C_0mm_1_kaos_o.wav" }, 
    { id: '1suba', audioSrc: "full_aH2p0_1_2_sub_a.wav" }, 
    { id: '1subi', audioSrc: "full_aH2p0_1_2_sub_i.wav" }, 
    { id: '1subu', audioSrc: "full_aH2p0_1_2_sub_u.wav" }, 
    { id: '1sube', audioSrc: "full_aH2p0_1_2_sub_e.wav" }, 
    { id: '1subo', audioSrc: "full_aH2p0_1_2_sub_o.wav" }, 
    { id: '2suba', audioSrc: "full_aH2p0_2_2_sub_a.wav" }, 
    { id: '2subi', audioSrc: "full_aH2p0_2_2_sub_i.wav" }, 
    { id: '2subu', audioSrc: "full_aH2p0_2_2_sub_u.wav" }, 
    { id: '2sube', audioSrc: "full_aH2p0_2_2_sub_e.wav" }, 
    { id: '2subo', audioSrc: "full_aH2p0_2_2_sub_o.wav" }, 
    { id: '1upa', audioSrc: "full_aH2p0_2_2_up_a.wav" }, 
    { id: '1upi', audioSrc: "full_aH2p0_2_2_up_i.wav" }, 
    { id: '1upu', audioSrc: "full_aH2p0_2_2_up_u.wav" }, 
    { id: '1upe', audioSrc: "full_aH2p0_2_2_up_e.wav" }, 
    { id: '1upo', audioSrc: "full_aH2p0_2_2_up_o.wav" }, 
    { id: '2upa', audioSrc: "full_H1p5_1_1.wav_up_a.wav" }, 
    { id: '2upi', audioSrc: "full_H1p5_1_1.wav_up_i.wav" }, 
    { id: '2upu', audioSrc: "full_H1p5_1_1.wav_up_u.wav" }, 
    { id: '2upe', audioSrc: "full_H1p5_1_1.wav_up_e.wav" }, 
    { id: '2upo', audioSrc: "full_H1p5_1_1.wav_up_o.wav" }, 
    { id: '1downa', audioSrc: "full_aH2p0_2_2.wav_down_a.wav" }, 
    { id: '1downi', audioSrc: "full_aH2p0_2_2.wav_down_i.wav" }, 
    { id: '1downu', audioSrc: "full_aH2p0_2_2.wav_down_u.wav" }, 
    { id: '1downe', audioSrc: "full_aH2p0_2_2.wav_down_e.wav" }, 
    { id: '1downo', audioSrc: "full_aH2p0_2_2.wav_down_o.wav" }, 
    { id: '2downa', audioSrc: "full_T10_2p5_1_1_down_a.wav" }, 
    { id: '2downi', audioSrc: "full_T10_2p5_1_1_down_i.wav" }, 
    { id: '2downu', audioSrc: "full_T10_2p5_1_1_down_u.wav" }, 
    { id: '2downe', audioSrc: "full_T10_2p5_1_1_down_e.wav" }, 
    { id: '2downo', audioSrc: "full_T10_2p5_1_1_down_o.wav" }, 
    { id: '1nona', audioSrc: "full_Lv1_1_3_a.wav" }, 
    { id: '1noni', audioSrc: "full_Lv1_1_3_i.wav" }, 
    { id: '1nonu', audioSrc: "full_Lv1_1_3_u.wav" }, 
    { id: '1none', audioSrc: "full_Lv1_1_3_e.wav" }, 
    { id: '1nono', audioSrc: "full_Lv1_1_3_o.wav" }, 
  ];

  // 表示する問題番号の順序リスト 
  const questionTextsInOrder = [
    '問1', '問2', '問3', '問4', '問5', '問6', '問7', '問8', '問9', '問10',
    '問11', '問12', '問13', '問14', '問15', '問16', '問17', '問18', '問19', '問20',
    '問21', '問22', '問23', '問24', '問25', '問26', '問27', '問28', '問29', '問30',
    '問31', '問32', '問33', '問34', '問35', '問36', '問37', '問38', '問39', '問40',
  ];

  let assignedQuestions = [];
  const answers = [];
  const playCounts = {};  
  
  const progressMeter = document.getElementById('progressMeter');
  const progressText = document.getElementById('progressText');
  
  progressMeter.max = questionTextsInOrder.length;
  progressText.textContent = `0 / ${questionTextsInOrder.length}`;


// 配列をランダムにシャッフルする関数 
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

 // 音声の再生回数をカウント 
 function countPlay(questionId) {
    if (!questionId.startsWith('global_')) { 
      if (!playCounts[questionId]) {
        playCounts[questionId] = 0;
      }
      playCounts[questionId]++;
    }
  }

// 進捗を更新する関数 
function updateProgress() {
  const uniqueQuestionIds = assignedQuestions.map(q => q.id); 
  let answeredCount = 0;
  
  uniqueQuestionIds.forEach(id => {
    // 母音の選択肢 (vowel_rating_X) が選択されているかのみチェック
    const vowelRatingInput = document.querySelector(`input[name="vowel_rating_${id}"]:checked`);
    
    // 母音の選択が完了していれば、回答完了とみなす
    if (vowelRatingInput) {
      answeredCount++;
    }
  });

  progressMeter.value = answeredCount;
  progressText.textContent = `${answeredCount} / ${questionTextsInOrder.length}`; 
}

// 共通の参考音声をロードする関数 
function loadGlobalReferenceAudios() {
    const container = document.getElementById('globalReferenceContainer');
    const displayCount = 4; 

    globalReferenceAudios.forEach((audio, index) => {
        const audioId = `global_${index}`;
        
        const audioItem = document.createElement('div');
        audioItem.className = 'global-audio-item';
        
        if (index >= displayCount) {
             audioItem.style.display = 'none'; 
        }

        audioItem.innerHTML = `
            <p>${audio.name}</p>
            <audio controls id="${audioId}" src="${audio.src}"></audio>
        `;
        container.appendChild(audioItem);

        const audioElement = document.getElementById(audioId);
        audioElement.addEventListener('play', () => countPlay(audioId));
    });

    if (globalReferenceAudios.length > displayCount) {
        const showAllButton = document.createElement('button');
        showAllButton.textContent = `残り${globalReferenceAudios.length - displayCount}件を表示`;
        showAllButton.onclick = function() {
            const hiddenItems = container.querySelectorAll('.global-audio-item');
            hiddenItems.forEach((item, index) => {
                if (index >= displayCount) {
                    item.style.display = 'inline-block';
                }
            });
            showAllButton.style.display = 'none'; 
        };
        container.appendChild(showAllButton);
    }
}


// 🚩修正: 設問の表示 (母音の選択肢をシャッフル)
function loadQuestions() {
    const container = document.getElementById("questionContainer");
    
    const shuffledQuestions = shuffleArray([...questions]);
    assignedQuestions = shuffledQuestions;

    questionTextsInOrder.forEach((questionText, index) => {
      
      const currentAssigned = assignedQuestions[index]; 
      const questionId = currentAssigned.id;
      const assignedAudioSrc = currentAssigned.audioSrc;
      
      const questionElement = document.createElement("div");
      
      // 母音の配列をシャッフル
      const shuffledVowels = shuffleArray([...vowels]);
      
      // シャッフルされた母音配列からラジオボタンのHTMLを生成
      let vowelOptionsHtml = '';
      shuffledVowels.forEach((vowel, vIndex) => {
        // 最初の要素に required をつけることで、どれか一つが必ず選択されるようにする
        const requiredAttr = (vIndex === 0) ? 'required' : ''; 
        vowelOptionsHtml += `
            <label><input type="radio" name="vowel_rating_${questionId}" value="${vowel}" ${requiredAttr}> ${vowel}</label>
        `;
      });

      // 母音の選択肢 (5択ラジオボタン)
      const vowelSelectionHtml = `
            <div>
                <p><strong>聞こえた母音の選択:</strong></p>
                <div class="vowel-selection">
                    ${vowelOptionsHtml}
                </div>
            </div>
      `;
      
      questionElement.innerHTML = `
                <p><strong>${questionText}</strong></p> 
                <audio controls id="audio${index}" src="${assignedAudioSrc}"></audio>
        ${vowelSelectionHtml}
        <hr>
      `;
      container.appendChild(questionElement);

      // --- イベントリスナーの追加 ---
      
      const audioElement = document.getElementById(`audio${index}`);
      audioElement.addEventListener('play', () => countPlay(questionId));

      // 母音選択肢の変更時に進捗を更新
      const vowelRatingInputs = document.querySelectorAll(`input[name="vowel_rating_${questionId}"]`);
      vowelRatingInputs.forEach(input => {
          input.addEventListener('change', updateProgress);
      });
    });
    
    updateProgress();
}

// Excel出力 
function submitAnswers() {
  updateProgress(); 

  answers.length = 0;  
  let uncompletedCount = 0;

  assignedQuestions.forEach((data, index) => {
    const questionId = data.id;
    const questionText = questionTextsInOrder[index];
    const audioFileName = data.audioSrc; 
    const playCount = playCounts[questionId] || 0; 
    
    const vowelInput = document.querySelector(`input[name="vowel_rating_${questionId}"]:checked`);
    const userVowel = vowelInput ? vowelInput.value : '';
    
    answers.push({
      displayOrder: questionText, 
      id: questionId,            
      audioFile: audioFileName, 
      userAnswer: userVowel, 
      playCount: playCount    
    });
    
    if (userVowel === "") {
        uncompletedCount++;
    }
  });
  
  if (uncompletedCount > 0) {
    if (!confirm(`未回答の質問が${uncompletedCount}件あります。このまま保存しますか？`)) {
      return; 
    }
  }

  alert("アンケートが完了しました。");
  downloadExcel();
}

// Excelファイルとしてダウンロード 
function downloadExcel() {
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(answers);
  XLSX.utils.book_append_sheet(wb, ws, "回答");
  XLSX.writeFile(wb, "answers.xlsx");
}

// 共通の参考音声を先にロードする
loadGlobalReferenceAudios();
// ページをロードした際に質問をランダムに表示
loadQuestions();
</script>
</body>
</html>