<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>アンケート</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    /* プログレスバーのスタイル（進捗状況メーター） */
    #progressContainer {
      margin-bottom: 20px;
      text-align: center;
    }
    progress {
      width: 80%;
      height: 25px;
    }
    
    /* 聞き心地メーターのスタイル（評価） */
    .evaluation-area {
      margin-top: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 10px;
    }
    .evaluation-scale label {
      margin-right: 15px;
      cursor: pointer;
    }
    .evaluation-area meter {
      width: 100px; /* メーターの幅 */
      height: 20px;
      /* 聞き心地が良い(5)が最適値となるよう設定 */
    }

    /* ★追加: 共通の参考音声エリアのスタイル */
    #globalReferenceContainer {
        border: 2px solid #007bff;
        padding: 15px;
        margin-bottom:15px;
        border-radius: 8px;
        background-color: #e9f7ff;
    }
    .global-audio-item {
        margin-top: 10px;
        display: inline-block; /* 横並びにする */
        margin-right: 10px;
    }
    /* 個別の質問用の参考音声は今回は削除。もし残したい場合は元のコードを参照 */
  </style>
</head>
<body>
  <h1>アンケート</h1>
  
  <div id="progressContainer">
    <label for="progressMeter">進捗状況:</label>
    <progress id="progressMeter" value="0" max="1"></progress> 
    <span id="progressText">0 / 1</span>
  </div>

  <div id="globalReferenceContainer">
      <h2>母音の参考音声</h2>
      </div>
    
  <div id="questionContainer"></div>
  
  <button onclick="submitAnswers()">回答を保存</button>
  
<script>
  // ★追加: 共通の参考音声データ (5つ定義)
  const globalReferenceAudios = [
      { name: 'あ', src: 'full_Lv1_1_4_a.wav' },
      { name: 'い', src: 'full_Lv1_1_4_i.wav' },
      { name: 'う', src: 'full_Lv1_1_4_u.wav' },
      { name: 'え', src: 'full_Lv1_1_4_e.wav' },
      { name: 'お', src: 'full_Lv1_1_4_o.wav' } // 5つ目
  ];

  // ★修正1: 設問データ (IDと音声ファイルをペアにする。textはランダムにしない)
  const questions = [
    // idとaudioSrcのペアは固定
    { id: '1kaosa', audioSrc: "full_VM6C_0mm_1_kaos_a.wav" }, 
    { id: '1kaosi', audioSrc: 'full_VM6C_0mm_1_kaos_i.wav' },
    { id: '1kaosu', audioSrc: 'full_VM6C_0mm_1_kaos_u.wav' },
    { id: '1kaose', audioSrc: 'full_VM6C_0mm_1_kaos_e.wav' },
    { id: '1kaoso', audioSrc: "full_VM6C_0mm_1_kaos_o.wav" }, 
    { id: '1suba', audioSrc: "full_aH2p0_1_2_sub_a.wav" }, 
    { id: '1subi', audioSrc: "full_aH2p0_1_2_sub_i.wav" }, 
    { id: '1subu', audioSrc: "full_aH2p0_1_2_sub_u.wav" }, 
    { id: '1sube', audioSrc: "full_aH2p0_1_2_sub_e.wav" }, 
    { id: '1subo', audioSrc: "full_aH2p0_1_2_sub_o.wav" }, 
    { id: '2suba', audioSrc: "full_aS2p0_2_2_sub_a.wav" }, 
    { id: '2subi', audioSrc: "full_aS2p0_2_2_sub_i.wav" }, 
    { id: '2subu', audioSrc: "full_aS2p0_2_2_sub_u.wav" }, 
    { id: '2sube', audioSrc: "full_aS2p0_2_2_sub_e.wav" }, 
    { id: '2subo', audioSrc: "full_aS2p0_2_2_sub_o.wav" }, 
    { id: '1upa', audioSrc: "full_aH2p0_2_2_up_a.wav" }, 
    { id: '1upi', audioSrc: "full_aH2p0_2_2_up_i.wav" }, 
    { id: '1upu', audioSrc: "full_aH2p0_2_2_up_u.wav" }, 
    { id: '1upe', audioSrc: "full_aH2p0_2_2_up_e.wav" }, 
    { id: '1upo', audioSrc: "full_aH2p0_2_2_up_o.wav" }, 
    { id: '2upa', audioSrc: "full_H1p5_1_1.wav_up_a.wav" }, 
    { id: '2upi', audioSrc: "full_H1p5_1_1.wav_up_i.wav" }, 
    { id: '2upu', audioSrc: "full_H1p5_1_1.wav_up_u.wav" }, 
    { id: '2upe', audioSrc: "full_H1p5_1_1.wav_up_e.wav" }, 
    { id: '2upo', audioSrc: "full_H1p5_1_1.wav_up_o.wav" }, 
    { id: '1downa', audioSrc: "full_aH2p0_2_2.wav_down_a.wav" }, 
    { id: '1downi', audioSrc: "full_aH2p0_2_2.wav_down_i.wav" }, 
    { id: '1downu', audioSrc: "full_aH2p0_2_2.wav_down_u.wav" }, 
    { id: '1downe', audioSrc: "full_aH2p0_2_2.wav_down_e.wav" }, 
    { id: '1downo', audioSrc: "full_aH2p0_2_2.wav_down_o.wav" }, 
    { id: '2downa', audioSrc: "full_T10_2p5_1_1_down_a.wav" }, 
    { id: '2downi', audioSrc: "full_T10_2p5_1_1_down_i.wav" }, 
    { id: '2downu', audioSrc: "full_T10_2p5_1_1_down_u.wav" }, 
    { id: '2downe', audioSrc: "full_T10_2p5_1_1_down_e.wav" }, 
    { id: '2downo', audioSrc: "full_T10_2p5_1_1_down_o.wav" }, 
    { id: '1nona', audioSrc: "full_Lv1_1_3_a.wav" }, 
    { id: '1noni', audioSrc: "full_Lv1_1_3_i.wav" }, 
    { id: '1nonu', audioSrc: "full_Lv1_1_3_u.wav" }, 
    { id: '1none', audioSrc: "full_Lv1_1_3_e.wav" }, 
    { id: '1nono', audioSrc: "full_Lv1_1_3_o.wav" }, 
    // ...
  ];

  // ★追加: 表示する問題番号の順序リスト (textだけ順序通りに表示するために必要)
  const questionTextsInOrder = [
    '問1',
    '問2',
    '問3',
    '問4',
    '問5',
    '問6',
    '問7',
    '問8',
    '問9',
    '問10',
    '問11',
    '問12',
    '問13',
    '問14',
    '問15',
    '問16',
    '問17',
    '問18',
    '問19',
    '問20',
    '問21',
    '問22',
    '問23',
    '問24',
    '問25',
    '問26',
    '問27',
    '問28',
    '問29',
    '問30',
    '問31',
    '問32',
    '問33',
    '問34',
    '問35',
    '問36',
    '問37',
    '問38',
    '問39',
    '問40',
    // ... questionsと同じ数だけ定義
  ];

  // ★追加: 設問IDと表示順序を紐づけるためのグローバル変数
  // loadQuestionsでシャッフルした結果をここに保存し、submitAnswersで利用する
  let assignedQuestions = [];


  const answers = [];
  const playCounts = {};  
  
  const progressMeter = document.getElementById('progressMeter');
  const progressText = document.getElementById('progressText');
  
  // 問題番号のリストの長さで進捗を決定
  progressMeter.max = questionTextsInOrder.length;
  progressText.textContent = `0 / ${questionTextsInOrder.length}`;


// 配列をランダムにシャッフルする関数 (変更なし)
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

 // 音声の再生回数をカウント (変更なし)
 function countPlay(questionId) {
    if (!questionId.startsWith('global_')) { 
      if (!playCounts[questionId]) {
        playCounts[questionId] = 0;
      }
      playCounts[questionId]++;
    }
  }

// 進捗を更新する関数
function updateProgress() {
  const inputs = document.querySelectorAll('#questionContainer input[data-question-id]');
  let answeredCount = 0;
  
  // uniqueQuestionIds はシャッフルされたIDリストを参照
  const uniqueQuestionIds = [...new Set(Array.from(inputs).map(input => input.getAttribute('data-question-id')))];
  
  uniqueQuestionIds.forEach(id => {
    const textInput = document.querySelector(`input[data-question-id="${id}"][type="text"]`);
    const ratingInput = document.querySelector(`input[name="rating_${id}"]:checked`);
    
    // テキスト入力があり、かつ評価ラジオボタンが選択されていれば、回答完了とみなす
    if (textInput && textInput.value.trim() !== "" && ratingInput) {
      answeredCount++;
    }
  });

  // プログレスバーのvalueと表示テキストを更新
  progressMeter.value = answeredCount;
  progressText.textContent = `${answeredCount} / ${questionTextsInOrder.length}`; // questionTextsInOrderの長さを参照
}

// 聞き心地メーターの表示を更新する関数 (変更なし)
function updateMeter(questionId, value) {
    const meterElement = document.getElementById(`meter_${questionId}`);
    if (meterElement) {
        meterElement.value = value;
    }
}

// 共通の参考音声をロードする関数 (変更なし)
function loadGlobalReferenceAudios() {
    // ... (関数の中身は変更なし)
    const container = document.getElementById('globalReferenceContainer');
    const displayCount = 4; 

    globalReferenceAudios.forEach((audio, index) => {
        const audioId = `global_${index}`;
        
        const audioItem = document.createElement('div');
        audioItem.className = 'global-audio-item';
        
        if (index >= displayCount) {
             audioItem.style.display = 'none'; 
        }

        audioItem.innerHTML = `
            <p>${audio.name}</p>
            <audio controls id="${audioId}" src="${audio.src}"></audio>
        `;
        container.appendChild(audioItem);

        const audioElement = document.getElementById(audioId);
        audioElement.addEventListener('play', () => countPlay(audioId));
    });

    if (globalReferenceAudios.length > displayCount) {
        const showAllButton = document.createElement('button');
        showAllButton.textContent = `残り${globalReferenceAudios.length - displayCount}件を表示`;
        showAllButton.onclick = function() {
            const hiddenItems = container.querySelectorAll('.global-audio-item');
            hiddenItems.forEach((item, index) => {
                if (index >= displayCount) {
                    item.style.display = 'inline-block';
                }
            });
            showAllButton.style.display = 'none'; 
        };
        container.appendChild(showAllButton);
    }
}


// ★修正2: 設問IDと音声のペアをシャッフルし、問題番号（text）は順序通りに表示
function loadQuestions() {
    const container = document.getElementById("questionContainer");
    
    // 1. IDと音声のペア全体をシャッフル
    const shuffledQuestions = shuffleArray([...questions]);

    // 2. シャッフルされた設問データをグローバル変数に保存
    assignedQuestions = shuffledQuestions;

    // 3. 問題番号リスト (questionTextsInOrder) を順序通りにループする
    questionTextsInOrder.forEach((questionText, index) => {
      
      // 順序通りのインデックスを使って、シャッフルされた設問データを取得
      const currentAssigned = assignedQuestions[index]; 
      const questionId = currentAssigned.id;
      const assignedAudioSrc = currentAssigned.audioSrc;
      
      const questionElement = document.createElement("div");
      
      const evaluationHtml = `
        <div class="evaluation-area">
          <p><strong>聞き心地評価 (1:悪い ～ 5:良い)</strong></p>
          <div class="evaluation-scale">
            <label><input type="radio" name="rating_${questionId}" value="1" required> 1</label>
            <label><input type="radio" name="rating_${questionId}" value="2"> 2</label>
            <label><input type="radio" name="rating_${questionId}" value="3"> 3</label>
            <label><input type="radio" name="rating_${questionId}" value="4"> 4</label>
            <label><input type="radio" name="rating_${questionId}" value="5"> 5</label>
            <br>
            <meter id="meter_${questionId}" min="1" max="5" low="2" high="4" optimum="5" value="0">評価されていません</meter>
          </div>
        </div>
      `;
      
      questionElement.innerHTML = `
                <p><strong>${questionText}</strong></p> 
                <audio controls id="audio${index}" src="${assignedAudioSrc}"></audio>
        <div>
          <label for="answerInput${index}">回答:</label>
                    <input type="text" id="answerInput${index}" placeholder="ここに回答を入力" data-question-id="${questionId}">
        </div>
        ${evaluationHtml}
        <hr>
      `;
      container.appendChild(questionElement);

      // --- イベントリスナーの追加 ---
      
      // イベントリスナーには、シャッフルされた questionId を渡す
      const audioElement = document.getElementById(`audio${index}`);
      audioElement.addEventListener('play', () => countPlay(questionId));

      const answerInput = document.getElementById(`answerInput${index}`);
      answerInput.addEventListener('input', updateProgress);
      
      const ratingInputs = document.querySelectorAll(`input[name="rating_${questionId}"]`);
      ratingInputs.forEach(input => {
          input.addEventListener('change', (event) => {
              updateMeter(questionId, event.target.value); 
              updateProgress(); 
          });
      });
    });
    
    updateProgress();
}

// ★修正3: グローバル変数 assignedQuestions からデータを取得してExcel出力
function submitAnswers() {
  updateProgress(); 

  answers.length = 0;  
  let uncompletedCount = 0;

  // assignedQuestions をループすることで、シャッフルされたIDと音声名を取得できる
  assignedQuestions.forEach((data, index) => {
    const questionId = data.id;
    // 表示された問題番号を questionTextsInOrder から取得
    const questionText = questionTextsInOrder[index];
    const audioFileName = data.audioSrc; 
    const playCount = playCounts[questionId] || 0; 
    
    // 回答と評価は questionId を使ってDOMから取得
    const inputElement = document.querySelector(`input[data-question-id="${questionId}"][type="text"]`);
    const ratingInput = document.querySelector(`input[name="rating_${questionId}"]:checked`);
    
    const userAnswer = inputElement ? inputElement.value : '';
    const ratingValue = ratingInput ? ratingInput.value : '';
    
    answers.push({
      // 回答データには、シャッフル後の設問IDと、順序通りの問題番号、割り当てられた音声を含める
      displayOrder: questionText, // 例: '問1'
      id: questionId,            // 例: 'question003'
      audioFile: audioFileName, 
      userAnswer: userAnswer, 
      audioRating: ratingValue, 
      playCount: playCount    
    });
    
    if (userAnswer.trim() === "" || ratingValue === "") {
        uncompletedCount++;
    }
  });
  
  if (uncompletedCount > 0) {
    if (!confirm(`未回答または未評価の質問が${uncompletedCount}件あります。このまま保存しますか？`)) {
      return; 
    }
  }

  alert("アンケートが完了しました。");
  downloadExcel();
}

// Excelファイルとしてダウンロード (変更なし)
function downloadExcel() {
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(answers);
  XLSX.utils.book_append_sheet(wb, ws, "回答");
  XLSX.writeFile(wb, "answers.xlsx");
}

// 共通の参考音声を先にロードする
loadGlobalReferenceAudios();
// ページをロードした際に質問をランダムに表示
loadQuestions();
</script>
</body>
</html>